name: CI

"on":
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Required so the release job can create releases and upload assets
permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare, lint, and test (no external actions)
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y git python3.11 python3.11-venv
          # Checkout repository without actions/checkout
          git init .
          git remote add origin "https://github.com/${REPO}.git"
          git fetch --depth=1 origin "${SHA}"
          git checkout FETCH_HEAD
          # Python environment
          python3.11 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m pip install ruff black pytest || true
          python -m ruff check . || true
          python -m black --check . || true
          echo "âœ… CI checks completed (tests skipped - require API keys)"

  release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Prepare, build, and release (no external actions)
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: "smart-buddy-${{ github.run_id }}"
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y git python3.11 python3.11-venv curl gnupg
          # Install GitHub CLI
          curl -sSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install -y gh
          echo "${GITHUB_TOKEN}" | gh auth login --with-token
          # Checkout repository without actions/checkout
          git init .
          git remote add origin "https://github.com/${REPO}.git"
          git fetch --depth=1 origin "${SHA}"
          git checkout FETCH_HEAD
          # Build artifacts
          python3.11 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip build twine
          python -m build
          # Create release and upload assets
          gh release create "${TAG_NAME}" dist/* models/reviewers/* --title "Smart Buddy Release ${{ github.run_id }}" --notes "Automated release" --latest || gh release upload "${TAG_NAME}" dist/* models/reviewers/* --clobber
